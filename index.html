<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XmlEditor - Gerador e Publicador Automático CT-e/MDF-e/NF-e</title>
    <!-- Fonte Inter (Premium) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
/* ===== DESIGN SYSTEM SAAS PREMIUM ===== */
:root {
    /* Cores Premium */
    --primary: #7c3aed;
    --primary-dark: #5b21b6;
    --primary-light: #c4b5fd;
    --secondary: #059669;
    --accent: #d97706;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #dc2626;
    --info: #3b82f6;
    
    /* Escala de Cinza Profissional */
    --gray-50: #fafafa;
    --gray-100: #f4f4f5;
    --gray-200: #e4e4e7;
    --gray-300: #d4d4d8;
    --gray-400: #a1a1aa;
    --gray-500: #71717a;
    --gray-600: #52525b;
    --gray-700: #3f3f46;
    --gray-800: #27272a;
    --gray-900: #18181b;
    
    /* Tipografia */
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-heading: 'Poppins', var(--font-sans);
    --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
    
    /* Espaçamentos */
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    
    /* Bordas */
    --radius-sm: 0.375rem;
    --radius: 0.75rem;
    --radius-lg: 1rem;
    --radius-xl: 1.5rem;
    --radius-2xl: 2rem;
    
    /* Sombras */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

/* ===== RESET & BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-sans);
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--gray-700);
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    padding: var(--space-xl);
}

/* ===== CONTAINER PRINCIPAL ===== */
.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius-2xl);
    padding: var(--space-2xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-200);
}

/* ===== HEADER ===== */
.header {
    text-align: center;
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--gray-200);
}

.header h1 {
    font-size: 2.25rem;
    font-weight: 700;
    background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: var(--space-sm);
}

.header .subtitle {
    color: var(--gray-600);
    font-size: 1rem;
}

/* ===== STATUS BAR ===== */
.status-bar {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: var(--space-lg);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-2xl);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    box-shadow: var(--shadow-md);
}

/* ===== FORM GRID COM LAYOUT DO SEU PRIMEIRO CÓDIGO ===== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-xl);
    margin-bottom: var(--space-2xl);
}

.input-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: var(--space-sm);
}

.form-label i {
    color: var(--primary);
}

.form-input {
    width: 100%;
    padding: var(--space-lg);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    background: var(--gray-50);
    border: 2px solid var(--gray-300);
    border-radius: var(--radius);
    transition: all 0.3s ease;
    color: var(--gray-800);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.form-input.readonly {
    background: var(--gray-100);
    color: var(--gray-600);
    border-color: var(--gray-200);
    cursor: not-allowed;
}

/* ===== API TOKEN SECTION ===== */
.api-section {
    background: var(--gray-50);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    margin-bottom: var(--space-2xl);
    border: 1px solid var(--gray-200);
}

.api-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.api-header h3 {
    color: var(--gray-800);
    font-size: 1.125rem;
}

.token-display {
    background: var(--gray-900);
    color: var(--gray-200);
    padding: var(--space-md);
    border-radius: var(--radius);
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    overflow-x: auto;
    margin-bottom: var(--space-md);
    max-height: 100px;
    overflow-y: auto;
}

.token-status {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
}

.token-status .valid {
    color: var(--success);
}

.token-status .invalid {
    color: var(--danger);
}

/* ===== BUTTONS ===== */
.action-buttons {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--space-md);
    margin: var(--space-2xl) 0;
}

.btn {
    padding: var(--space-lg) var(--space-xl);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    font-weight: 600;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    position: relative;
    overflow: hidden;
}

.btn i {
    font-size: 1.125rem;
}

.btn-primary {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-info {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-danger {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* ===== OUTPUT SECTION - MANTÉM O TERMINAL HACKER ===== */
.output-section {
    background: var(--gray-900);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    margin-top: var(--space-2xl);
}

.output-header {
    color: white;
    margin-bottom: var(--space-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.output-content {
    background: #000;
    color: #00ff00;
    border-radius: var(--radius);
    padding: var(--space-xl);
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.7;
    overflow-x: auto;
    min-height: 200px;
    border: 1px solid var(--gray-700);
}

/* ===== DOWNLOAD LINKS ===== */
.download-links {
    display: none;
    margin-top: var(--space-xl);
    text-align: center;
}

.download-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: var(--space-md) var(--space-xl);
    margin: 0 var(--space-sm);
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-md);
}

.download-link:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* ===== LOADING ANIMATION ===== */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px) {
    .action-buttons {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 1024px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .action-buttons {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    body {
        padding: var(--space-md);
    }
    
    .container {
        padding: var(--space-xl);
    }
    
    .header h1 {
        font-size: 1.75rem;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .download-links {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }
    
    .download-link {
        margin: 0;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER COM TEMA PREMIUM -->
        <div class="header">
            <h1><i class="fas fa-code"></i> XML EDITOR - GERADOR E PUBLICADOR AUTOMÁTICO</h1>
            <p class="subtitle">Sistema Premium - XMLs base carregados na memória | Integração com iComprova/NDD Cargo</p>
        </div>
        
        <!-- STATUS BAR -->
        <div class="status-bar">
            <i class="fas fa-check-circle"></i>
            <span>SISTEMA PRONTO - XMLs BASE CARREGADOS NA MEMÓRIA</span>
        </div>
        
        <!-- API TOKEN SECTION -->
        <div class="api-section">
            <div class="api-header">
                <h3><i class="fas fa-key"></i> AUTENTICAÇÃO iCOMPROVA API</h3>
                <div class="token-status">
                    <span id="tokenStatusText" class="invalid">Token não obtido</span>
                    <i id="tokenStatusIcon" class="fas fa-times-circle" style="color: var(--danger);"></i>
                </div>
            </div>
            <div class="token-display" id="tokenDisplay">
                Clique em "Obter Token" para autenticar na API iComprova/NDD Cargo...
            </div>
            <button class="btn btn-primary" onclick="obterTokenAPI()">
                <i class="fas fa-key"></i> OBTER TOKEN API
            </button>
        </div>
        
        <!-- FORM GRID COM LAYOUT DO SEU PRIMEIRO CÓDIGO -->
        <div class="form-grid">
            <!-- CT-e -->
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-hashtag"></i> NOVO NÚMERO CT-e:
                </label>
                <input type="number" id="numeroCte" class="form-input" placeholder="091732" value="91732" min="1" step="1">
            </div>
            
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-key"></i> CHAVE CT-e GERADA:
                </label>
                <input type="text" id="chaveCte" class="form-input readonly" readonly>
                <small id="statusCte" style="color: var(--gray-500); margin-top: var(--space-xs);">Clique em "Gerar Chaves"</small>
            </div>
            
            <!-- MDF-e -->
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-hashtag"></i> NOVO NÚMERO MDF-e:
                </label>
                <input type="number" id="numeroMdfe" class="form-input" placeholder="091732" value="91732" min="1" step="1">
            </div>
            
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-key"></i> CHAVE MDF-e GERADA:
                </label>
                <input type="text" id="chaveMdfe" class="form-input readonly" readonly>
                <small id="statusMdfe" style="color: var(--gray-500); margin-top: var(--space-xs);">Clique em "Gerar Chaves"</small>
            </div>
            
            <!-- NF-e -->
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-hashtag"></i> NOVO NÚMERO NF-e:
                </label>
                <input type="number" id="numeroNfe" class="form-input" placeholder="000001" value="1" min="1" step="1">
            </div>
            
            <div class="input-group">
                <label class="form-label">
                    <i class="fas fa-key"></i> CHAVE NF-e GERADA:
                </label>
                <input type="text" id="chaveNfe" class="form-input readonly" readonly>
                <small id="statusNfe" style="color: var(--gray-500); margin-top: var(--space-xs);">Clique em "Gerar Chaves"</small>
            </div>
        </div>
        
        <!-- CAMPO DATA COM FORMATO DO SEU PRIMEIRO CÓDIGO -->
        <div class="input-group">
            <label class="form-label">
                <i class="fas fa-calendar-alt"></i> DATA EMISSÃO (YYYY-MM-DDTHH:MM:SS-03:00):
            </label>
            <input type="text" id="dataEmissao" class="form-input" value="2025-09-27T10:00:00-03:00">
        </div>
        
        <!-- BOTÕES COM ÍCONES E ESTILO PREMIUM -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="gerarChaves()">
                <i class="fas fa-key"></i> GERAR CHAVES
            </button>
            <button class="btn btn-success" onclick="gerarXMLs()">
                <i class="fas fa-bolt"></i> GERAR XMLs
            </button>
            <button class="btn btn-warning" onclick="baixarTudo()">
                <i class="fas fa-download"></i> BAIXAR TUDO
            </button>
            <button class="btn btn-info" onclick="autoProximaViagem()">
                <i class="fas fa-redo"></i> PRÓXIMA VIAGEM
            </button>
            <button class="btn btn-success" onclick="publicarMDFe()" id="btnPublicarMDFe">
                <i class="fas fa-cloud-upload-alt"></i> PUBLICAR MDF-e
            </button>
            <button class="btn btn-info" onclick="publicarCTe()" id="btnPublicarCTe">
                <i class="fas fa-cloud-upload-alt"></i> PUBLICAR CT-e
            </button>
        </div>
        
        <!-- OUTPUT SECTION - MANTÉM O TERMINAL HACKER -->
        <div class="output-section">
            <div class="output-header">
                <h3><i class="fas fa-terminal"></i> LOG DE OPERAÇÕES</h3>
                <span id="outputStatus" style="color: var(--gray-400);">Aguardando operação...</span>
            </div>
            <div class="output-content" id="output">
                <!-- Resultados aparecem aqui -->
            </div>
        </div>
        
        <!-- LINKS DE DOWNLOAD -->
        <div class="download-links" id="downloadLinks">
            <a href="#" class="download-link" id="linkCte">
                <i class="fas fa-file-download"></i> BAIXAR CT-e
            </a>
            <a href="#" class="download-link" id="linkMdfe">
                <i class="fas fa-file-download"></i> BAIXAR MDF-e
            </a>
            <a href="#" class="download-link" id="linkZip">
                <i class="fas fa-file-archive"></i> BAIXAR ZIP
            </a>
        </div>
    </div>

    <!-- JAVASCRIPT DO SEU PRIMEIRO CÓDIGO (FUNCIONAL) COM ADIÇÕES PARA API -->
    <script>
        // ============================================
        // DADOS FIXOS DA SUA EMPRESA (DOS SEUS XMLs)
        // ============================================
        const DADOS_EMPRESA = {
            cUF: '41',                    // PR - Paraná
            CNPJ: '11158565000118',       // Seu CNPJ
            modelo: '57',                 // CT-e
            serie: '1',                   // Série
            tpEmis: '1',                  // Normal
            cDV: '7',                     // DV da chave original
            
            // Para MDF-e
            modeloMDFe: '58',             // MDF-e
            serieMDFe: '22',              // Série MDF-e
            tpAmb: '1',                   // Produção
            cMDF: '02328384',             // Código MDF-e
            
            // Para NF-e (NOVO - ADICIONADO AGORA)
            modeloNFE: '55',              // NF-e modelo 55
            serieNFE: '1',                // Série NF-e
            cNF: '12345678'               // Código numérico NF-e (pode ser qualquer número de 8 dígitos)
        };

        // ============================================
        // CONFIGURAÇÕES DA API iCOMPROVA
        // ============================================
        const API_CONFIG = {
            tokenUrl: "https://icomprova.nddcargo.com.br:9051/connect/token",
            baseUrl: "https://icomprova.nddcargo.com.br:9051/api",
            clientId: "4a3a17846e714b3288682c5260455347",
            clientSecret: "FFVkTyaM4zVsLYAhKpGIT57C72EzYPSOqFO+O/P9y0Y=",
            scope: "i-comprova-entregas-integration-api",
            grantType: "client_credentials"
        };

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let accessToken = null;
        let tokenExpiry = null;
        let cteGerado = null;
        let mdfeGerado = null;
        let ultimoNumeroCTe = 91731;
        let ultimoNumeroMDFe = 91731;
        let ultimoNumeroNFe = 1;

        // ============================================
        // XMLs BASE FIXOS NA MEMÓRIA (CORRIGIDOS - SEM DUPLICAÇÃO)
        // ============================================
        const CTE_BASE = `<?xml version="1.0" encoding="UTF-8"?>
<cteProc versao="3.00" xmlns="http://www.portalfiscal.inf.br/cte">
	<CTe xmlns="http://www.portalfiscal.inf.br/cte">
		<infCte Id="CTe41250611158565000118570010000917261001054737" versao="3.00">
			<ide>
				<cUF>41</cUF>
				<cCT>00105473</cCT>
				<CFOP>6352</CFOP>
				<natOp>PRESTACAO  SERVICOS DE  TRANSPORTES</natOp>
				<mod>57</mod>
				<serie>1</serie>
				<nCT>091731</nCT>
				<dhEmi>2025-09-26T12:43:00-03:00</dhEmi>
				<tpImp>1</tpImp>
				<tpEmis>1</tpEmis>
				<cDV>7</cDV>
				<tpAmb>1</tpAmb>
				<tpCTe>0</tpCTe>
				<procEmi>0</procEmi>
				<verProc>NDDigital CTe 4.8.5</verProc>
				<cMunEnv>4125506</cMunEnv>
				<xMunEnv>SAO JOSE DOS PINHAIS</xMunEnv>
				<UFEnv>PR</UFEnv>
				<modal>01</modal>
				<tpServ>0</tpServ>
				<cMunIni>4125506</cMunIni>
				<xMunIni>SAO JOSE DOS PINHAIS</xMunIni>
				<UFIni>PR</UFIni>
				<cMunFim>3554102</cMunFim>
				<xMunFim>TAUBATE</xMunFim>
				<UFFim>SP</UFFim>
				<retira>1</retira>
				<indIEToma>1</indIEToma>
				<toma3>
					<toma>0</toma>
				</toma3>
			</ide>
			<compl>
				<xCaracAd>Teste CadTnp</xCaracAd>
				<xCaracSer>Teste CadSer</xCaracSer>
				<xEmi>Teste FunEmi</xEmi>
				<fluxo>
					<pass>
						<xPass>Teste SigPas</xPass>
					</pass>
				</fluxo>
				<Entrega>
					<semData>
						<tpPer>0</tpPer>
					</semData>
					<semHora>
						<tpHor>0</tpHor>
					</semHora>
				</Entrega>
				<xObs>DEVOLUCAO DE PECAS/EMBALAGENS -  / DATA VENCIMENTO: 10/01/2024 / PLACA:AUU0D40 - RENAVAM:899048080 / PLACA REBOQUE:AKM8I69 - RENAVAM:00791445631 / PLACA REBOQUE (2):DJE9039 - RENAVAM:00791445631 / MOTORISTA:PAULO MONTEIRO WATERKEMPER - CPF:65446410220 / CARTAO PEDAGIO:0000000000000000 ID:14771862365 VALOR:647,88 / CVA:892451 - TIPO DE VIAGEM: FTL-BITREM -  / SEGURADORA: 4-RSA SEGUROS / APOLICE: 5400028799 / REQUISICAO: PEDIDO:7600024486 / CIOT:024035059815 /</xObs>
				<ObsCont xCampo="Obs Cmp Teste">
					<xTexto>.</xTexto>
				</ObsCont>
			</compl>
			<emit>
				<CNPJ>11158565000118</CNPJ>
				<IE>9032205116</IE>
				<xNome>Pré vendas transportadora</xNome>
				<xFant>SAO JOSE PINHAIS - PR</xFant>
				<enderEmit>
					<xLgr>RUA ANTONIO SINGER</xLgr>
					<nro>6.751</nro>
					<xBairro>CAMPO LARGO ROSEIRA</xBairro>
					<cMun>4125506</cMun>
					<xMun>SAO JOSE DOS PINHAIS</xMun>
					<CEP>83090901</CEP>
					<UF>PR</UF>
					<fone>00004133843470</fone>
				</enderEmit>
				<CRT>3</CRT>
			</emit>
			<rem>
				<CNPJ>59104422010384</CNPJ>
				<IE>9013276371</IE>
				<xNome>NDD TESTE MOVE</xNome>
				<xFant>NDD TESTE MOVE</xFant>
				<fone>00004133813568</fone>
				<enderReme>
					<xLgr>RUA ANTONIO SINGER</xLgr>
					<nro>6751</nro>
					<xBairro>CAMPO LARGO ROSEIRA</xBairro>
					<cMun>4125506</cMun>
					<xMun>SAO JOSE DOS PINHAIS</xMun>
					<CEP>83090901</CEP>
					<UF>PR</UF>
					<cPais>1058</cPais>
					<xPais>Brasil</xPais>
				</enderReme>
				<email>william.souza@ndd.tech</email>
			</rem>
			<exped>
				<CNPJ>59104422010384</CNPJ>
				<IE>9013276371</IE>
				<xNome>NDD TESTE MOVE</xNome>
				<fone>00004133813568</fone>
				<enderExped>
					<xLgr>RUA ANTONIO SINGER</xLgr>
					<nro>6751</nro>
					<xBairro>CAMPO LARGO ROSEIRA</xBairro>
					<cMun>4125506</cMun>
					<xMun>SAO JOSE DOS PINHAIS</xMun>
					<CEP>83090901</CEP>
					<UF>PR</UF>
					<cPais>1058</cPais>
					<xPais>Brasil</xPais>
				</enderExped>
				<email>joao.pinheiro@ndd.tech</email>
			</exped>
			<receb>
				<CNPJ>02147467000518</CNPJ>
				<IE>688165993113</IE>
				<xNome>NDD TESTE MOVE</xNome>
				<fone>00001236276408</fone>
				<enderReceb>
					<xLgr>R. Heitor Villa Lobos</xLgr>
					<nro>525</nro>
					<xBairro>São Francisco</xBairro>
					<cMun>4208702</cMun>
					<xMun>LAGES</xMun>
					<CEP>88506400</CEP>
					<UF>SC</UF>
					<cPais>1058</cPais>
					<xPais>Brasil</xPais>
				</enderReceb>
				<email>gpa-nfe@br.gestamp.com</email>
			</receb>
			<dest>
				<CNPJ>71363101000175</CNPJ>
				<IE>688165993113</IE>
				<xNome>NDD TESTE MOVE</xNome>
				<fone>00001236276408</fone>
				<enderDest>
					<xLgr>R. Heitor Villa Lobos</xLgr>
					<nro>525</nro>
					<xBairro>São Francisco</xBairro>
					<cMun>4208702</cMun>
					<xMun>LAGES</xMun>
					<CEP>88506400</CEP>
					<UF>SP</UF>
					<cPais>1058</cPais>
					<xPais>Brasil</xPais>
				</enderDest>
				<email>joao.pinheiro@ndd.tech</email>
			</dest>
			<vPrest>
				<vTPrest>1254.66</vTPrest>
				<vRec>1254.66</vRec>
				<Comp>
					<xNome>Frete/Unitario</xNome>
					<vComp>1254.66</vComp>
				</Comp>
				<Comp>
					<xNome>Frete/Peso</xNome>
					<vComp>1254.66</vComp>
				</Comp>
				<Comp>
					<xNome>Frete/Valor</xNome>
					<vComp>0.00</vComp>
				</Comp>
				<Comp>
					<xNome>Outros/Transbor</xNome>
					<vComp>0.00</vComp>
				</Comp>
				<Comp>
					<xNome>SEC-CAT</xNome>
					<vComp>0.00</vComp>
				</Comp>
				<Comp>
					<xNome>Pedagio</xNome>
					<vComp>0.00</vComp>
				</Comp>
				<Comp>
					<xNome>Despacho</xNome>
					<vComp>0.00</vComp>
				</Comp>
				<Comp>
					<xNome>Peso Total</xNome>
					<vComp>1000.00</vComp>
				</Comp>
			</vPrest>
			<imp>
				<ICMS>
					<ICMS00>
						<CST>00</CST>
						<vBC>1254.66</vBC>
						<pICMS>12.00</pICMS>
						<vICMS>150.56</vICMS>
					</ICMS00>
				</ICMS>
				<vTotTrib>150.56</vTotTrib>
			</imp>
			<infCTeNorm>
				<infCarga>
					<vCarga>87736.68</vCarga>
					<proPred>UNIDADE</proPred>
					<infQ>
						<cUnid>01</cUnid>
						<tpMed>PESO</tpMed>
						<qCarga>1000</qCarga>
					</infQ>
				</infCarga>
				<infDoc>
					<infNFe>
						<chave>41231159104422010384550380004425511317946100</chave>
					</infNFe>
				</infDoc>
				<infModal versaoModal="3.00">
					<rodo>
						<RNTRC>00109548</RNTRC>
					</rodo>
				</infModal>
				<cobr>
					<dup>
						<nDup>105458G 1</nDup>
						<dVenc>2024-01-10</dVenc>
						<vDup>1254.66</vDup>
					</dup>
				</cobr>
			</infCTeNorm>
		</infCte>
		<infCTeSupl>
			<qrCodCTe>http://www.fazenda.pr.gov.br/cte/qrcode?chCTe=41231111158565000118570010001054581001054737&amp;tpAmb=1</qrCodCTe>
		</infCTeSupl>
		<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
			<SignedInfo>
				<CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
				<SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
				<Reference URI="#CTe41231111158565000118570010001054581001054737">
					<Transforms>
						<Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
						<Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
					</Transforms>
					<DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
					<DigestValue>h0V9xLqpcwaRlwTSiJ1ai8/n7vI=</DigestValue>
				</Reference>
			</SignedInfo>
			<SignatureValue>Hev/TYisXsJpawWwvHid5L2+3TYZhOVJul53ilQXO79FpP89FscWa8jPPN5KaN0aQ5Y/C981wpjfY+Hr6PqmScSDMG2PHQ0ufxZNAvGZbJ3fb0YaMIceKU4WP8vHmkUUFyidRyDdmZTRLZruhy0L49kDFuG3Ap3or9aFOD/DqSXBTa+rA9ActBrXmuEJEEYU1Bs5fjNkyvA5ZwtSyRfPyqn0HGDcHHo1IzEi/zna/YUWCJwH3GWv9p6SqmPnkDklm5pf82lNEAmqFJPVZo2aeYDX4zr8nyhpdK6ZyGS8Hmfe62Up6wPxQxQxj/M5krqXwwinT1t0/MSGNuVteiWEFQ==</SignatureValue>
			<KeyInfo>
				<X509Data>
					<X509Certificate>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</X509Certificate>
				</X509Data>
			</KeyInfo>
		</Signature>
	</CTe>
	<protCTe versao="3.00">
		<infProt>
			<tpAmb>1</tpAmb>
			<verAplic>PR-v3_3_11</verAplic>
			<chCTe>41250611158565000118570010000917311001054737</chCTe>
			<dhRecbto>2025-09-26T12:44:54-03:00</dhRecbto>
			<nProt>141230252735166</nProt>
			<digVal>h0V9xLqpcwaRlwTSiJ1ai8/n7vI=</digVal>
			<cStat>100</cStat>
			<xMotivo>Autorizado o uso do CT-e</xMotivo>
		</infProt>
	</protCTe>
</cteProc>`;

        const MDFE_BASE = `<?xml version="1.0" encoding="UTF-8"?>
<mdfeProc versao="3.00" xmlns="http://www.portalfiscal.inf.br/mdfe">
	<MDFe xmlns="http://www.portalfiscal.inf.br/mdfe">
		<infMDFe Id="MDFe41250611158565000118580010000091728023283840" versao="3.00">
			<ide>
				<cUF>41</cUF>
				<tpAmb>1</tpAmb>
				<tpEmit>1</tpEmit>
				<mod>58</mod>
				<serie>22</serie>
				<nMDF>091731</nMDF>
				<cMDF>02328384</cMDF>
				<cDV>0</cDV>
				<modal>1</modal>
				<dhEmi>2025-09-26T13:10:00-03:00</dhEmi>
				<tpEmis>1</tpEmis>
				<procEmi>0</procEmi>
				<verProc>NDDigital MDFe 4.8.5</verProc>
				<UFIni>PR</UFIni>
				<UFFim>SP</UFFim>
				<infMunCarrega>
					<cMunCarrega>4125506</cMunCarrega>
					<xMunCarrega>SAO JOSE DOS PINHAIS</xMunCarrega>
				</infMunCarrega>
				<dhIniViagem>2025-06-17T13:10:00-03:00</dhIniViagem>
			</ide>
			<emit>
				<CNPJ>11158565000118</CNPJ>
				<IE>9032205116</IE>
				<xNome>Pré vendas transportadora</xNome>
				<xFant>SAO JOSE PINHAIS - PR</xFant>
				<enderEmit>
					<xLgr>RUA ANTONIO SINGER</xLgr>
					<nro>6.751</nro>
					<xBairro>CAMPO LARGO ROSEIRA</xBairro>
					<cMun>4125506</cMun>
					<xMun>SAO JOSE DOS PINHAIS</xMun>
					<CEP>83090901</CEP>
					<UF>PR</UF>
					<fone>49984094010</fone>
				</enderEmit>
			</emit>
			<infModal versaoModal="3.00">
				<rodo>
					<infANTT>
						<RNTRC>00109548</RNTRC>
						<valePed>
							<disp>
								<CNPJForn>04088208000165</CNPJForn>
								<CNPJPg>59104422010384</CNPJPg>
								<nCompra>14771862365</nCompra>
								<vValePed>647.88</vValePed>
								<tpValePed>01</tpValePed>
							</disp>
							<categCombVeic>08</categCombVeic>
						</valePed>
						<infContratante>
							<xNome>NDD TESTE MOVE</xNome>
							<CNPJ>59104422010384</CNPJ>
						</infContratante>
					</infANTT>
					<veicTracao>
						<placa>AUU0D40</placa>
						<RENAVAM>899048080</RENAVAM>
						<tara>0</tara>
						<capKG>0</capKG>
						<capM3>0</capM3>
						<condutor>
							<xNome>JOÃO VICTOR NUNES PINHEIRO</xNome>
							<CPF>01193932980</CPF>
						</condutor>
						<tpRod>06</tpRod>
						<tpCar>01</tpCar>
						<UF>PR</UF>
					</veicTracao>
				</rodo>
			</infModal>
			<infDoc>
				<infMunDescarga>
					<cMunDescarga>3554102</cMunDescarga>
					<xMunDescarga>TAUBATE</xMunDescarga>
					<infCTe>
						<chCTe>41250611158565000118570010000917311001054737</chCTe>
					</infCTe>
				</infMunDescarga>
			</infDoc>
			<seg>
				<infResp>
					<respSeg>2</respSeg>
					<CNPJ>59104422000150</CNPJ>
				</infResp>
				<infSeg>
					<xSeg>SOMPO SEGUROS</xSeg>
					<CNPJ>60405925000144</CNPJ>
				</infSeg>
				<nApol>5400026836</nApol>
				<nAver>KJP55152AO4SDTAX185B0ANV84RVRQZTR</nAver>
			</seg>
			<prodPred>
				<tpCarga>05</tpCarga>
				<xProd>B.ZINCADA</xProd>
				<cEAN>SEM GTIN</cEAN>
				<NCM>72104910</NCM>
				<infLotacao>
					<infLocalCarrega>
						<CEP>83000000</CEP>
					</infLocalCarrega>
					<infLocalDescarrega>
						<CEP>12072010</CEP>
					</infLocalDescarrega>
				</infLotacao>
			</prodPred>
			<tot>
				<qCTe>1</qCTe>
				<vCarga>87736.68</vCarga>
				<cUnid>01</cUnid>
				<qCarga>1000.0000</qCarga>
			</tot>
		</infMDFe>
		<infMDFeSupl>
			<qrCodMDFe>https://dfe-portal.svrs.rs.gov.br/mdfe/qrCode?chMDFe=41231111158565000118580010000104701023283840&amp;tpAmb=1</qrCodMDFe>
		</infMDFeSupl>
		<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
			<SignedInfo>
				<CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
				<SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
				<Reference URI="#MDFe41231111158565000118580010000104701023283840">
					<Transforms>
						<Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
						<Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
					</Transforms>
					<DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
					<DigestValue>Ik0DC6lkhsj+Z7SMl94tEJtw/rM=</DigestValue>
				</Reference>
			</SignedInfo>
			<SignatureValue>ob2TxaF8xgjNFQvyRLq09Z8Vqgbb57JGMSV2wd33JbGMOxRNgONxa3NarsPHZ1Nz5GkEjP/iH3MDnj4vjKL54LajvxP1k6m2uyS8t88qfBC/T0/BSd9M2/zP6+0OjOqW55+scM1zTAJ4mYsGq/NSG54veHy66gXx12VTXXJKT17brv5KDUgvhRlKp+OllSTBy8HDkJC0dXziLykEZunhaHJFrzSW0j7F6D1pc6hsooMHkztLNBCppTtJz0VADxCudQhfcIn/J0jRMFUDk0ZrQnWaQ5p5OulXlakV2i2QEw4Pd7bgtK7I56g0J18sZp3w8Yz+UFs8RIB0f7Oeb5PV2w==</SignatureValue>
			<KeyInfo>
				<X509Data>
					<X509Certificate>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</X509Certificate>
				</X509Data>
			</KeyInfo>
		</Signature>
	</MDFe>
	<protMDFe versao="3.00">
		<infProt Id="MDFe941230017668937">
			<tpAmb>1</tpAmb>
			<verAplic>RS20230403093610</verAplic>
			<chMDFe>41250611158565000118580010000091731023283840</chMDFe>
			<dhRecbto>2025-26-09T13:17:17-03:00</dhRecbto>
			<nProt>941230017668937</nProt>
			<digVal>Ik0DC6lkhsj+Z7SMl94tEJtw/rM=</digVal>
			<cStat>100</cStat>
			<xMotivo>Autorizado o uso do MDF-e</xMotivo>
		</infProt>
	</protMDFe>
</mdfeProc>`;

        // ============================================
        // FUNÇÕES PARA GERAR CHAVES DE ACESSO - CORRIGIDO!
        // ============================================

        function gerarChaveCTe(numeroCTe) {
            const nCT = numeroCTe.toString().padStart(9, '0');
            const serie = DADOS_EMPRESA.serie.padStart(3, '0');
            const cCT = '00105473';
            
            const AAMM = getAAMM();
            
            const chave43 = 
                DADOS_EMPRESA.cUF +
                AAMM +
                DADOS_EMPRESA.CNPJ +
                DADOS_EMPRESA.modelo +
                serie +
                nCT +
                DADOS_EMPRESA.tpEmis +
                cCT;
            
            const dv = calcularDigitoVerificador(chave43);
            return chave43 + dv;
        }

        function gerarChaveMDFe(numeroMDFe) {
            const nMDF = numeroMDFe.toString().padStart(9, '0');
            const serie = DADOS_EMPRESA.serieMDFe.padStart(3, '0');
            const cMDF = DADOS_EMPRESA.cMDF;
            
            const AAMM = getAAMM();
            
            const chave43 = 
                DADOS_EMPRESA.cUF +
                AAMM +
                DADOS_EMPRESA.CNPJ +
                DADOS_EMPRESA.modeloMDFe +
                serie +
                nMDF +
                DADOS_EMPRESA.tpEmis +
                cMDF;
            
            const dv = calcularDigitoVerificador(chave43);
            return chave43 + dv;
        }

        // ============================================
        // FUNÇÃO NOVA PARA GERAR CHAVE NF-e
        // ============================================
        function gerarChaveNFe(numeroNFe) {
            const nNF = numeroNFe.toString().padStart(9, '0');
            const serie = DADOS_EMPRESA.serieNFE.padStart(3, '0');
            const cNF = DADOS_EMPRESA.cNF;
            
            const AAMM = getAAMM();
            
            // Formato da chave NF-e: cUF (2) + AAMM (4) + CNPJ (14) + mod (2) + serie (3) + nNF (9) + tpEmis (1) + cNF (8)
            const chave43 = 
                DADOS_EMPRESA.cUF +
                AAMM +
                DADOS_EMPRESA.CNPJ +
                DADOS_EMPRESA.modeloNFE +
                serie +
                nNF +
                DADOS_EMPRESA.tpEmis +
                cNF;
            
            const dv = calcularDigitoVerificador(chave43);
            return chave43 + dv;
        }

        function getAAMM() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            return year + month;
        }

        function calcularDigitoVerificador(chave43) {
            let soma = 0;
            let peso = 2;
            
            for (let i = chave43.length - 1; i >= 0; i--) {
                soma += parseInt(chave43.charAt(i)) * peso;
                peso = (peso === 9) ? 2 : peso + 1;
            }
            
            const resto = soma % 11;
            const dv = (11 - resto);
            
            if (dv === 0 || dv === 1 || dv > 9) {
                return '0';
            }
            
            return dv.toString();
        }
		
        
        // ============================================
        // FUNÇÕES DA API iCOMPROVA
        // ============================================
        
        async function obterTokenAPI() {
    const output = document.getElementById('output');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const tokenStatusText = document.getElementById('tokenStatusText');
    const tokenStatusIcon = document.getElementById('tokenStatusIcon');
    
    output.innerHTML = `<span style="color: #00ff00;">[API] Obtendo token de autenticação...</span>`;
    
    try {
        const body = new URLSearchParams({
            client_id: API_CONFIG.clientId,
            client_secret: API_CONFIG.clientSecret,
            scope: API_CONFIG.scope,
            grant_type: API_CONFIG.grantType
        });

        const response = await fetch(API_CONFIG.tokenUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: body.toString()
        });

        const responseText = await response.text();

        if (!response.ok) {
            output.innerHTML += `<br><span style="color: #ff0000;">[API] Erro ${response.status}:</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">${responseText}</span>`;
            tokenStatusText.textContent = "Erro ao obter token";
            tokenStatusIcon.className = "fas fa-times-circle";
            tokenStatusIcon.style.color = "var(--danger)";
            return;
        }

        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            output.innerHTML += `<br><span style="color: #ff0000;">[API] Resposta não é JSON válido:</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">${responseText.substring(0, 200)}...</span>`;
            return;
        }
        
        accessToken = data.access_token;
        tokenExpiry = new Date(Date.now() + (data.expires_in * 1000));
        
        // Exibir token truncado para segurança
        const tokenTruncado = data.access_token.substring(0, 50) + '...';
        tokenDisplay.textContent = `TOKEN: ${tokenTruncado}\nEXPIRA EM: ${new Date(tokenExpiry).toLocaleString()}\nTIPO: ${data.token_type}`;
        
        tokenStatusText.textContent = "Token válido";
        tokenStatusText.className = "valid";
        tokenStatusIcon.className = "fas fa-check-circle";
        tokenStatusIcon.style.color = "var(--success)";
        
        output.innerHTML += `<br><span style="color: #00ff00;">[API] ✅ Token obtido com sucesso!</span>`;
        output.innerHTML += `<br><span style="color: #00ff00;">[API] Expira em: ${data.expires_in} segundos</span>`;
        
        // Habilitar botões de publicação
        document.getElementById('btnPublicarMDFe').disabled = false;
        document.getElementById('btnPublicarCTe').disabled = false;
        
    } catch (err) {
        output.innerHTML += `<br><span style="color: #ff0000;">[API] Erro de conexão: ${err.message}</span>`;
        tokenStatusText.textContent = "Erro de conexão";
        tokenStatusIcon.className = "fas fa-times-circle";
        tokenStatusIcon.style.color = "var(--danger)";
    }
}
        
        function verificarTokenValido() {
            if (!accessToken) {
                outputLog("[API] ❌ Token não disponível. Obtenha um token primeiro.");
                return false;
            }
            
            if (tokenExpiry && new Date() > tokenExpiry) {
                outputLog("[API] ❌ Token expirado. Obtenha um novo token.");
                return false;
            }
            
            return true;
        }
        
        // ============================================
        // FUNÇÕES DE PUBLICAÇÃO PARA API
        // ============================================
        
        async function publicarMDFe() {
    if (!verificarTokenValido()) return;
    if (!mdfeGerado) {
        outputLog("[API] ❌ MDF-e não gerado. Gere os XMLs primeiro.");
        return;
    }
    
    const output = document.getElementById('output');
    const btn = document.getElementById('btnPublicarMDFe');
    const originalText = btn.innerHTML;
    
    output.innerHTML += `<br><span style="color: #00ff00;">[API] Enviando MDF-e para iComprova...</span>`;
    btn.innerHTML = '<div class="loading"></div> Enviando...';
    btn.disabled = true;
    
    try {
        // Converter XML para string Base64 (como exigido pela API)
        const xmlBase64 = btoa(unescape(encodeURIComponent(mdfeGerado)));
        
        const response = await fetch(`${API_CONFIG.baseUrl}/Recepcoes/MDFe`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                documento: xmlBase64
            })
        });
        
        // Primeiro pega a resposta como texto
        const responseText = await response.text();
        
        // Tenta parsear como JSON, se falhar, mostra o texto puro
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            // Se não for JSON, mostra o que veio
            output.innerHTML += `<br><span style="color: #ff9900;">[API] Resposta não-JSON recebida:</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">${responseText.substring(0, 500)}...</span>`;
            result = { status: "unknown", rawResponse: responseText };
        }
        
        if (response.ok) {
            if (result.status === "success") {
                output.innerHTML += `<br><span style="color: #00ff00;">[API] ✅ MDF-e enviado com sucesso!</span>`;
                output.innerHTML += `<br><span style="color: #00ff00;">[API] ID: ${result.id || 'N/A'}</span>`;
                output.innerHTML += `<br><span style="color: #00ff00;">[API] MDF-e aguardando envio dos CT-es vinculados...</span>`;
            } else {
                output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Status não-success: ${result.status || 'unknown'}</span>`;
                output.innerHTML += `<br><span style="color: #ff0000;">[API] Mensagem: ${result.message || 'Sem mensagem'}</span>`;
            }
        } else {
            output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro HTTP ${response.status}: ${response.statusText}</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">[API] Resposta: ${responseText.substring(0, 300)}</span>`;
        }
        
    } catch (error) {
        output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro de conexão: ${error.message}</span>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
    
    const output = document.getElementById('output');
    const btn = document.getElementById('btnPublicarCTe');
    const originalText = btn.innerHTML;
    
    output.innerHTML += `<br><span style="color: #00ff00;">[API] Enviando CT-e para iComprova...</span>`;
    btn.innerHTML = '<div class="loading"></div> Enviando...';
    btn.disabled = true;
    
    try {
        // Converter XML para string Base64 (como exigido pela API)
        const xmlBase64 = btoa(unescape(encodeURIComponent(cteGerado)));
        
        // Extrair chave do CT-e para usar como token
        const chaveCte = document.getElementById('chaveCte').value;
        
        const response = await fetch(`${API_CONFIG.baseUrl}/Recepcoes/CTe`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                documento: xmlBase64,
                token: chaveCte
            })
        });
        
        // Primeiro pega a resposta como texto
        const responseText = await response.text();
        
        // Tenta parsear como JSON, se falhar, mostra o texto puro
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            // Se não for JSON, mostra o que veio
            output.innerHTML += `<br><span style="color: #ff9900;">[API] Resposta não-JSON recebida:</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">${responseText.substring(0, 500)}...</span>`;
            result = { status: "unknown", rawResponse: responseText };
        }
        
        if (response.ok) {
            if (result.status === "success") {
                output.innerHTML += `<br><span style="color: #00ff00;">[API] ✅ CT-e enviado com sucesso!</span>`;
                output.innerHTML += `<br><span style="color: #00ff00;">[API] ID: ${result.id || 'N/A'}</span>`;
                output.innerHTML += `<br><span style="color: #00ff00;">[API] Viagem será disponibilizada após envio de todos os documentos.</span>`;
            } else {
                output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Status não-success: ${result.status || 'unknown'}</span>`;
                output.innerHTML += `<br><span style="color: #ff0000;">[API] Mensagem: ${result.message || 'Sem mensagem'}</span>`;
            }
        } else {
            output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro HTTP ${response.status}: ${response.statusText}</span>`;
            output.innerHTML += `<br><span style="color: #ff9900;">[API] Resposta: ${responseText.substring(0, 300)}</span>`;
        }
        
    } catch (error) {
        output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro de conexão: ${error.message}</span>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
        
        async function publicarCTe() {
            if (!verificarTokenValido()) return;
            if (!cteGerado) {
                outputLog("[API] ❌ CT-e não gerado. Gere os XMLs primeiro.");
                return;
			}
        }
            
            const output = document.getElementById('output');
            const btn = document.getElementById('btnPublicarCTe');
            const originalText = btn.innerHTML;
            
            output.innerHTML += `<br><span style="color: #00ff00;">[API] Enviando CT-e para iComprova...</span>`;
            btn.innerHTML = '<div class="loading"></div> Enviando...';
            btn.disabled = true;
            
            try {
                // Converter XML para string Base64 (como exigido pela API)
                const xmlBase64 = btoa(unescape(encodeURIComponent(cteGerado)));
                
                // Extrair chave do CT-e para usar como token
                const chaveCte = document.getElementById('chaveCte').value;
                
                const response = await fetch(`${API_CONFIG.baseUrl}/Recepcoes/CTe`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        documento: xmlBase64,
                        token: chaveCte
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === "success") {
                    output.innerHTML += `<br><span style="color: #00ff00;">[API] ✅ CT-e enviado com sucesso!</span>`;
                    output.innerHTML += `<br><span style="color: #00ff00;">[API] ID: ${result.id || 'N/A'}</span>`;
                    output.innerHTML += `<br><span style="color: #00ff00;">[API] Viagem será disponibilizada após envio de todos os documentos.</span>`;
                } else {
                    output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro ao enviar CT-e: ${result.message || 'Erro desconhecido'}</span>`;
                    if (result.errors) {
                        output.innerHTML += `<br><span style="color: #ff9900;">[API] Detalhes: ${JSON.stringify(result.errors)}</span>`;
                    }
                }
                
            } catch (error) {
                output.innerHTML += `<br><span style="color: #ff0000;">[API] ❌ Erro de conexão: ${error.message}</span>`;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Função para publicar NF-e (caso necessário)
        async function publicarNFe() {
            if (!verificarTokenValido()) return;
            
            const output = document.getElementById('output');
            output.innerHTML += `<br><span style="color: #00ff00;">[API] Função de envio NF-e será implementada conforme necessidade...</span>`;
        }
        
        // ============================================
        // FUNÇÕES PRINCIPAIS DA INTERFACE (ORIGINAIS)
        // ============================================
        
        function outputLog(message) {
            const output = document.getElementById('output');
            output.innerHTML += `<br>${message}`;
            output.scrollTop = output.scrollHeight;
        }
        
        function gerarChaves() {
            const numeroCte = parseInt(document.getElementById('numeroCte').value) || ultimoNumeroCTe + 1;
            const numeroMdfe = parseInt(document.getElementById('numeroMdfe').value) || ultimoNumeroMDFe + 1;
            const numeroNfe = parseInt(document.getElementById('numeroNfe').value) || ultimoNumeroNFe + 1;
            
            document.getElementById('numeroCte').value = numeroCte;
            document.getElementById('numeroMdfe').value = numeroMdfe;
            document.getElementById('numeroNfe').value = numeroNfe;
            
            const chaveCte = gerarChaveCTe(numeroCte);
            const chaveMdfe = gerarChaveMDFe(numeroMdfe);
            const chaveNfe = gerarChaveNFe(numeroNfe);
            
            document.getElementById('chaveCte').value = chaveCte;
            document.getElementById('chaveMdfe').value = chaveMdfe;
            document.getElementById('chaveNfe').value = chaveNfe;
            
            document.getElementById('statusCte').textContent = `✅ Chave válida (44 dígitos)`;
            document.getElementById('statusMdfe').textContent = `✅ Chave válida (44 dígitos)`;
            document.getElementById('statusNfe').textContent = `✅ Chave válida (44 dígitos)`;
            
            document.getElementById('output').innerHTML = `
                <div style="color: #00ff00; font-weight: bold;">
                    🔑 CHAVES GERADAS AUTOMATICAMENTE!
                </div>
                <div style="margin-top: 15px;">
                    <strong>CT-e ${numeroCte}:</strong> ${chaveCte}<br>
                    <strong>MDF-e ${numeroMdfe}:</strong> ${chaveMdfe}<br>
                    <strong>NF-e ${numeroNfe}:</strong> ${chaveNfe}
                </div>
            `;
            
            document.getElementById('outputStatus').textContent = 'Chaves geradas com sucesso';
            document.getElementById('outputStatus').style.color = '#10b981';
            
            ultimoNumeroCTe = numeroCte;
            ultimoNumeroMDFe = numeroMdfe;
            ultimoNumeroNFe = numeroNfe;
        }
        
        function gerarXMLs() {
            try {
                const numeroCte = document.getElementById('numeroCte').value;
                const chaveCte = document.getElementById('chaveCte').value;
                const numeroMdfe = document.getElementById('numeroMdfe').value;
                const chaveMdfe = document.getElementById('chaveMdfe').value;
                const numeroNfe = document.getElementById('numeroNfe').value;
                const chaveNfe = document.getElementById('chaveNfe').value;
                const dataEmissao = document.getElementById('dataEmissao').value;
                
                if (!chaveCte || chaveCte.length !== 44) {
                    alert('Gere as chaves primeiro! Clique em "Gerar Chaves"');
                    return;
                }
                
                // GERAR NOVO CT-e
                cteGerado = CTE_BASE
                    .replace(/CTe\d{44}/g, `CTe${chaveCte}`)
                    .replace(/<nCT>\d+<\/nCT>/, `<nCT>${numeroCte.padStart(6, '0')}</nCT>`)
                    .replace(/<chCTe>\d+<\/chCTe>/, `<chCTe>${chaveCte}</chCTe>`)
                    .replace(/<dhEmi>[^<]+<\/dhEmi>/, `<dhEmi>${dataEmissao}</dhEmi>`)
                    .replace(/chCTe=\d+/g, `chCTe=${chaveCte}`)
                    .replace(/<nDup>[^<]+<\/nDup>/, `<nDup>${numeroCte}G 1</nDup>`)
                    .replace(/<dhRecbto>[^<]+<\/dhRecbto>/, `<dhRecbto>${dataEmissao}</dhRecbto>`);
                
                // GERAR NOVO MDF-e
                mdfeGerado = MDFE_BASE
                    .replace(/MDFe\d{44}/g, `MDFe${chaveMdfe}`)
                    .replace(/<nMDF>\d+<\/nMDF>/, `<nMDF>${numeroMdfe.padStart(6, '0')}</nMDF>`)
                    .replace(/<chMDFe>\d+<\/chMDFe>/, `<chMDFe>${chaveMdfe}</chMDFe>`)
                    .replace(/<chCTe>\d+<\/chCTe>/, `<chCTe>${chaveCte}</chCTe>`)
                    .replace(/<dhEmi>[^<]+<\/dhEmi>/, `<dhEmi>${dataEmissao}</dhEmi>`)
                    .replace(/<dhIniViagem>[^<]+<\/dhIniViagem>/, `<dhIniViagem>${dataEmissao}</dhIniViagem>`)
                    .replace(/chMDFe=\d+/g, `chMDFe=${chaveMdfe}`)
                    .replace(/<dhRecbto>[^<]+<\/dhRecbto>/, `<dhRecbto>${dataEmissao}</dhRecbto>`);
                
                document.getElementById('output').innerHTML += `
                    <div style="color: #00ff00; margin-top: 20px; border-top: 1px solid #00ff00; padding-top: 20px;">
                        ✅ XMLs GERADOS COM SUCESSO!
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>CT-e:</strong> Número ${numeroCte} | Chave ${chaveCte}<br>
                        <strong>MDF-e:</strong> Número ${numeroMdfe} | Chave ${chaveMdfe}<br>
                        <strong>NF-e:</strong> Número ${numeroNfe} | Chave ${chaveNfe}<br>
                        <strong>Data Emissão:</strong> ${dataEmissao}
                    </div>
                `;
                
                document.getElementById('downloadLinks').style.display = 'flex';
                document.getElementById('linkCte').onclick = (e) => { e.preventDefault(); baixarCTe(); };
                document.getElementById('linkMdfe').onclick = (e) => { e.preventDefault(); baixarMDFe(); };
                document.getElementById('linkZip').onclick = (e) => { e.preventDefault(); baixarZIP(); };
                
                document.getElementById('outputStatus').textContent = 'XMLs gerados com sucesso';
                document.getElementById('outputStatus').style.color = '#10b981';
                
            } catch (error) {
                document.getElementById('output').innerHTML = 
                    `<div style="color: #ff0000;">❌ ERRO: ${error.message}</div>`;
                document.getElementById('outputStatus').textContent = 'Erro ao gerar XMLs';
                document.getElementById('outputStatus').style.color = '#dc2626';
            }
        }
        
        function autoProximaViagem() {
            const novoNumeroCTe = ultimoNumeroCTe + 1;
            const novoNumeroMDFe = ultimoNumeroMDFe + 1;
            const novoNumeroNFe = ultimoNumeroNFe + 1;
            
            document.getElementById('numeroCte').value = novoNumeroCTe;
            document.getElementById('numeroMdfe').value = novoNumeroMDFe;
            document.getElementById('numeroNfe').value = novoNumeroNFe;
            
            gerarChaves();
            
            setTimeout(() => {
                gerarXMLs();
                document.getElementById('output').innerHTML += 
                    `<div style="color: #00ff00; margin-top: 10px;">🔄 PRÓXIMA VIAGEM CONFIGURADA AUTOMATICAMENTE!</div>`;
            }, 500);
        }
        
        function baixarCTe() {
            if (!cteGerado) return;
            const blob = new Blob([cteGerado], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CTe_${document.getElementById('chaveCte').value}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function baixarMDFe() {
            if (!mdfeGerado) return;
            const blob = new Blob([mdfeGerado], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MDFe_${document.getElementById('chaveMdfe').value}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function baixarZIP() {
            if (!cteGerado || !mdfeGerado) return;
            
            if (window.JSZip) {
                const zip = new JSZip();
                zip.file(`CTe_${document.getElementById('chaveCte').value}.xml`, cteGerado);
                zip.file(`MDFe_${document.getElementById('chaveMdfe').value}.xml`, mdfeGerado);
                
                zip.generateAsync({ type: 'blob' }).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `XMLs_${document.getElementById('chaveCte').value}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            } else {
                baixarCTe();
                setTimeout(() => baixarMDFe(), 500);
            }
        }
        
        function baixarTudo() {
            if (!cteGerado || !mdfeGerado) {
                alert('Gere os XMLs primeiro!');
                return;
            }
            baixarZIP();
        }
        
        // Carregar JSZip dinamicamente
        if (!window.JSZip) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            document.head.appendChild(script);
        }
        
        // Gerar chaves iniciais ao carregar
        window.addEventListener('DOMContentLoaded', () => {
            // COLOCA DATA ATUAL AUTOMÁTICA
            const agora = new Date();
            const ano = agora.getFullYear();
            const mes = String(agora.getMonth() + 1).padStart(2, '0');
            const dia = String(agora.getDate()).padStart(2, '0');
            const hora = String(agora.getHours()).padStart(2, '0');
            const minuto = String(agora.getMinutes()).padStart(2, '0');
            const segundo = String(agora.getSeconds()).padStart(2, '0');
            
            // Formato que os XMLs precisam: YYYY-MM-DDTHH:MM:SS-03:00
            const dataAtual = `${ano}-${mes}-${dia}T${hora}:${minuto}:${segundo}-03:00`;
            
            // Joga a data atual no campo
            document.getElementById('dataEmissao').value = dataAtual;
            
            // Agora sim gera as chaves
            gerarChaves();
            
            // Inicializar botões de publicação como desabilitados
            document.getElementById('btnPublicarMDFe').disabled = true;
            document.getElementById('btnPublicarCTe').disabled = true;
        });
    </script>
</body>
</html>
